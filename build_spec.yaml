version: 0.1
component: build

timeoutInSeconds: 3600

env:
  variables:
    # Ajusta segÃºn tu namespace y repo
    REGISTRY: mx-queretaro-1.ocir.io
    NAMESPACE: axm8kysebnqa
    REPO: reacttodo/s78fu/todolistapp-springboot

steps:
  - type: Command
    name: Login to OCIR
    command: |
      echo "ðŸ”‘ Autenticando en OCIR..."
      echo "${auth_token_ocir}" \
        | docker login $REGISTRY \
            -u "${user_ocir}" \
            --password-stdin

  - type: Command
    name: Build & Push Docker image
    command: |
      echo "ðŸ”¨ Construyendo y subiendo imagen multi-stage..."
      # nos movemos al contexto donde estÃ¡ Dockerfile
      cd MtdrSpring/backend

      # tag dinÃ¡mico: usa image_tag si viene definido, si no "latest"
      TAG=${image_tag:-latest}

      docker build \
        -f Dockerfile \
        -t $REGISTRY/$NAMESPACE/$REPO:$TAG \
        .

      docker push $REGISTRY/$NAMESPACE/$REPO:$TAG

outputArtifacts:
  - name: todolist-image
    type: DOCKER_IMAGE
    location: ${REGISTRY}/${NAMESPACE}/${REPO}:${image_tag:-latest}
