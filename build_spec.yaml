version: 0.1
component: build

timeoutInSeconds: 3600

env:
  variables:
    REGISTRY: mx-queretaro-1.ocir.io
    NAMESPACE: axm8kysebnqa
    REPO: reacttodo/s78fu/todolistapp-springboot
    TAG: ${OCI_BUILD_RUN_ID}      # ‚Üê usamos el build‚Äêrun ID como tag din√°mico

steps:
  - type: Command
    name: Login to OCIR
    command: |
      echo "üîë Autenticando en OCIR..."
      echo "${auth_token_ocir}" \
        | docker login ${REGISTRY} \
            -u "${user_ocir}" \
            --password-stdin

  - type: Command
    name: Build & Push multi-stage con TAG √∫nico
    command: |
      echo "üî® Construyendo y subiendo imagen con tag $TAG..."
      cd MtdrSpring/backend

      docker build -f Dockerfile \
        -t ${REGISTRY}/${NAMESPACE}/${REPO}:${TAG} \
        .

      docker push ${REGISTRY}/${NAMESPACE}/${REPO}:${TAG}

outputArtifacts:
  - name: todolist-image
    type: DOCKER_IMAGE
    location: ${REGISTRY}/${NAMESPACE}/${REPO}:${TAG}
