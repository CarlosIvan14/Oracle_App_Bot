version: 0.1          # debe ser exactamente 0.1
component: build      # indica que esto es un build spec

timeoutInSeconds: 3600  # 1 h

steps:
  - type: Command
    name: Build Application
    command: |
      echo "ðŸš€ FORCING Java 11 Environment..."
      
      # Nuclear option - find and use Java 11 explicitly
      export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which javac))))
      export PATH=$JAVA_HOME/bin:$PATH
      
      # Verify environment
      echo "=== ENVIRONMENT VERIFICATION ==="
      echo "Java path: $(which java)"
      echo "Java version:"
      java -version
      echo "Javac version:"
      javac -version
      echo "Maven version:"
      mvn -version
      
      # Build with absolute certainty
      cd MtdrSpring/backend
      mvn clean package spring-boot:repackage
      
      # Verify output
      echo "=== BUILD OUTPUT ==="
      ls -la target/
      find target/ -name "*.jar" -exec du -h {} \;
    image: maven:3.8.6-openjdk-11

  - type: Command
    name: Login to OCIR
    command: |
      echo "ðŸ”‘ Autenticando en OCIR..."
      # Ajusta la regiÃ³n si no es mx-queretaro-1
      REGISTRY=mx-queretaro-1.ocir.io
      echo "${auth_token_ocir}" \
        | docker login $REGISTRY \
            -u "${user_ocir}" \
            --password-stdin

  - type: Command
    name: Build & Push Docker image
    command: |
      echo "ðŸ”¨ Construyendo y subiendo imagen Docker..."
      cd MtdrSpring/backend

      # Usa 'latest' si image_tag no estÃ¡ definido
      TAG=${image_tag:-latest}
      REGISTRY=mx-queretaro-1.ocir.io
      NAMESPACE=ax8nnzejeioc   
      REPO=reacttodo/xkmym/todolistapp-springboot

      # Build with simple Dockerfile
      docker build \
        -t $REGISTRY/$NAMESPACE/$REPO:$TAG \
        -f Dockerfile \
        .

      # Push
      docker push $REGISTRY/$NAMESPACE/$REPO:$TAG

outputArtifacts:
  - name: todolist-image          # â‘  Identificador interno del artefacto
    type: DOCKER_IMAGE            # â‘¡ Le indica a DevOps que es una imagen Docker
    location: mx-queretaro-1.ocir.io/ax8nnzejeioc/reacttodo/xkmym/todolistapp-springboot:${image_tag}