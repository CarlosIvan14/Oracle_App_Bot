version: 0.1          # no lo cambies
component: build

timeoutInSeconds: 3600  # 1 hora

# si quieres inyectar el tag dinÃ¡mico desde la variable `image_tag`, 
# puedes usarlo para sobreescribir IMAGE_VERSION
env:
  variables:
    DOCKER_REGISTRY: mx-queretaro-1.ocir.io/axm8kysebnqa/reacttodo/s78fu
    # si no pasas image_tag, por defecto 0.1 (igual que en tu script)
    IMAGE_VERSION: ${image_tag:-0.1}

steps:
  - type: Command
    name: Login to OCIR
    command: |
      echo "ðŸ”‘ Autenticando en OCIR..."
      echo "${auth_token_ocir}" \
        | docker login mx-queretaro-1.ocir.io \
            -u "${user_ocir}" \
            --password-stdin
  - type: Command
    name: Instalar Java 11
    command: |
      echo "ðŸ“¦ Instalando OpenJDK 11..."
      sudo yum install -y java-11-openjdk-devel
      export JAVA_HOME=/usr/lib/jvm/java-11-openjdk
      export PATH=$JAVA_HOME/bin:$PATH
      
  - type: Command
    name: Ejecutar build.sh
    command: |
      echo "ðŸ”¨ Ejecutando build.sh"
      cd MtdrSpring/backend
      chmod +x build.sh

      # exportar las vars que tu script espera
      export DOCKER_REGISTRY=${DOCKER_REGISTRY}
      export IMAGE_VERSION=${IMAGE_VERSION}

      ./build.sh

outputArtifacts:
  - name: todolist-image
    type: DOCKER_IMAGE
    # AquÃ­ definimos dÃ³nde estÃ¡ la imagen final, usando el mismo tag
    location: mx-queretaro-1.ocir.io/axm8kysebnqa/reacttodo/s78fu/todolistapp-springboot:${IMAGE_VERSION}
    outputArtifacts:
  - name: todolist-image          # â‘  Identificador interno del artefacto
    type: DOCKER_IMAGE            # â‘¡ Le indica a DevOps que es una imagen Docker
    location: mx-queretaro-1.ocir.io/axm8kysebnqa/reacttodo/s78fu/todolistapp-springboot:${image_tag}

