version: 0.1
component: build
timeoutInSeconds: 3600

steps:
  - type: Command
    name: Set dynamic tag
    command: |
      echo "⏳ Generando tag dinámico..."
      export TAG=$(date +%s)
      echo "TAG=$TAG" > image_tag.env

  - type: Command
    name: Login to OCIR
    command: |
      echo "🔑 Autenticando en OCIR..."
      REGISTRY=mx-queretaro-1.ocir.io
      echo "${auth_token_ocir}" \
        | docker login $REGISTRY \
            -u "${user_ocir}" \
            --password-stdin

  - type: Command
    name: Build & Push Docker image
    command: |
      source image_tag.env
      echo "🔨 Construyendo y subiendo imagen con tag: $TAG"
      cd MtdrSpring/backend

      REGISTRY=mx-queretaro-1.ocir.io
      NAMESPACE=ax8nnzejeioc
      REPO=reacttodo/xkmym/todolistapp-springboot

      docker build \
        -t $REGISTRY/$NAMESPACE/$REPO:$TAG \
        -f Dockerfile \
        .

      docker push $REGISTRY/$NAMESPACE/$REPO:$TAG

  - type: Command
    name: Generate deployment file with tag
    command: |
      echo "📝 Reemplazando tag en plantilla de despliegue..."
      source image_tag.env
      sed "s/__TAG__/$TAG/" deployment-template.yaml > deployment.yaml

  - type: Command
    name: Apply deployment
    command: |
      echo "🚀 Desplegando a Kubernetes..."
      kubectl apply -f deployment.yaml

outputArtifacts:
  - name: todolist-image
    type: DOCKER_IMAGE
    location: mx-queretaro-1.ocir.io/ax8nnzejeioc/reacttodo/xkmym/todolistapp-springboot
