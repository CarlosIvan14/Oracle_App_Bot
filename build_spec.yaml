version: 0.1
component: build

timeoutInSeconds: 3600

env:
  variables:
    REGISTRY: mx-queretaro-1.ocir.io
    NAMESPACE: axm8kysebnqa
    REPO: reacttodo/s78fu/todolistapp-springboot

steps:
  - type: Command
    name: Login to OCIR
    command: |
      echo "ðŸ”‘ Autenticando en OCIR..."
      echo "${auth_token_ocir}" \
        | docker login $REGISTRY \
            -u "${user_ocir}" \
            --password-stdin

  - type: Command
    name: Build & Push multi-stage con TAG dinÃ¡mico
    command: |
      echo "ðŸ”¨ Generando TAG dinÃ¡mico y construyendo imagen..."
      cd MtdrSpring/backend

      # SHA corto del commit
      GIT_SHA=$(git rev-parse --short HEAD)
      # Timestamp UTC opcional
      TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
      # Formato de TAG
      TAG="${TIMESTAMP}-${GIT_SHA}"
      echo "Usando TAG = $TAG"

      # ConstrucciÃ³n y push
      docker build \
        -f Dockerfile \
        -t $REGISTRY/$NAMESPACE/$REPO:$TAG \
        .
      docker push $REGISTRY/$NAMESPACE/$REPO:$TAG

      # Guardamos el TAG en un archivo para exportarlo
      echo "TAG=$TAG" > build_env_vars

  - type: ExportVariables
    name: Exportar TAG
    variables:
      - env-file: build_env_vars

outputArtifacts:
  - name: todolist-image
    type: DOCKER_IMAGE
    # Ahora usamos $TAG que acabamos de exportar
    location: $REGISTRY/$NAMESPACE/$REPO:$TAG
