version: 0.1
component: build
timeoutInSeconds: 3600

steps:
  - type: Command
    name: Build Application
    command: |
      echo "üî® Building Spring Boot application..."
      cd MtdrSpring/backend
      
      echo "=== JAVA VERSION ==="
      java -version
      echo "=== MAVEN VERSION ==="
      mvn -version
      
      mvn clean package spring-boot:repackage
      
      echo "=== BUILD OUTPUT ==="
      ls -la target/
      find target/ -name "*.jar" -exec du -h {} \;
    image: maven:3.8.6-amazoncorretto-11

  - type: Command
    name: Login to OCIR
    command: |
      echo "üîë Authenticating to OCIR..."
      echo "${auth_token_ocir}" | \
      docker login mx-queretaro-1.ocir.io \
        -u "${user_ocir}" \
        --password-stdin

  - type: Command
    name: Build & Push Docker Image
    command: |
      echo "üê≥ Building Docker image..."
      cd MtdrSpring/backend

      # Use the OCI parameter or fallback to 'latest'
      TAG="${image_tag:-latest}"
      echo "Using tag: $TAG"
      
      FULL_IMAGE_NAME="mx-queretaro-1.ocir.io/ax8nnzejeioc/reacttodo/xkmym/todolistapp-springboot:$TAG"
      
      echo "Full image name: $FULL_IMAGE_NAME"
      echo "=== Docker images before build ==="
      docker images

      docker build -t "$FULL_IMAGE_NAME" -f Dockerfile .

      echo "=== Docker images after build ==="
      docker images | grep todolistapp || true

      echo "üöÄ Pushing image to OCIR..."
      docker push "$FULL_IMAGE_NAME"


outputArtifacts:
  - name: todolist-image
    type: DOCKER_IMAGE
    location: mx-queretaro-1.ocir.io/ax8nnzejeioc/reacttodo/xkmym/todolistapp-springboot:${image_tag}
