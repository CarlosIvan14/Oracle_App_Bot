version: 0.2
component: build

timeoutInSeconds: 3600
env:
  variables:
    REGISTRY: mx-queretaro-1.ocir.io
    NAMESPACE: axm8kysebnqa
    REPO: reacttodo/s78fu/todolistapp-springboot

phases:
  install:
    runtime-versions:
      docker: 20
  build:
    commands:
      - echo "ðŸ”‘ Autenticandoâ€¦"
      - echo "${auth_token_ocir}" | docker login $REGISTRY -u "${user_ocir}" --password-stdin
      - echo "ðŸ”¨ Preparando buildâ€¦"
      - cd MtdrSpring/backend
      # 1) SHA corto
      - GIT_SHA=$(git rev-parse --short HEAD)
      # 2) Timestamp
      - TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
      # 3) Tag final
      - TAG="${TIMESTAMP}-${GIT_SHA}"
      - echo "Usando TAG = $TAG"
      # 4) Build y push
      - docker build -f Dockerfile -t $REGISTRY/$NAMESPACE/$REPO:$TAG .
      - docker push $REGISTRY/$NAMESPACE/$REPO:$TAG
      # 5) Guardo la URI completa para el artifact
      - echo "IMAGE_URI=$REGISTRY/$NAMESPACE/$REPO:$TAG" > image.properties

artifacts:
  dockerImages:
    - name: todolist-image
      # OCI DevOps v0.2 sustituye variables al vuelo
      imageUri: $REGISTRY/$NAMESPACE/$REPO:$TAG
